name: PEN Engine CI

on:
  push:
    branches: [main]
    paths:
      - 'engine/**'
      - '.github/workflows/pen-engine.yml'
      - 'docs/phase1_evidence_contract.md'
  pull_request:
    branches: [main]
    paths:
      - 'engine/**'
      - '.github/workflows/pen-engine.yml'
      - 'docs/phase1_evidence_contract.md'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6'
          cabal-version: '3.10'

      - name: Cache cabal packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/store
            engine/dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('engine/pen-engine.cabal') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Build all targets
        working-directory: engine
        run: cabal build all

      - name: Prepare Phase 1 artifact directory
        run: |
          RUN_DIR="runs/phase1_ci/${{ github.run_id }}-${{ github.run_attempt }}"
          mkdir -p "$RUN_DIR"
          echo "RUN_DIR=$RUN_DIR" >> $GITHUB_ENV

      - name: Capture environment metadata
        run: |
          {
            echo "commit_sha=${{ github.sha }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
            echo "ref=${{ github.ref }}"
            echo "runner_os=${{ runner.os }}"
            echo "runner_arch=${{ runner.arch }}"
            echo "ghc_version=$(ghc --version)"
            echo "cabal_version=$(cabal --version | head -n 1)"
          } > "$RUN_DIR/env.txt"

      - name: Lane A — acceptance-core (required)
        working-directory: engine
        run: |
          cabal run acceptance-core | tee "../$RUN_DIR/acceptance-core.log"

      - name: Lane B — acceptance-mbtt bounded (required on PR/main)
        working-directory: engine
        run: |
          cabal run acceptance-mbtt -- --mbtt-fast --mbtt-max-candidates 50             | tee "../$RUN_DIR/acceptance-mbtt-fast.log"

      - name: Lane C — acceptance-mbtt full (main branch)
        if: github.ref == 'refs/heads/main'
        working-directory: engine
        run: |
          cabal run acceptance-mbtt | tee "../$RUN_DIR/acceptance-mbtt-full.log"

      - name: Lane D — MBTT-first structural replay
        working-directory: engine
        run: |
          cabal run ab-initio -- --structural --mbtt-first --mbtt-max-candidates 200 --csv abinitio_mbtt_structural.csv             | tee "../$RUN_DIR/abinitio_mbtt_structural.log"
          mv abinitio_mbtt_structural.csv "../$RUN_DIR/abinitio_mbtt_structural.csv"

      - name: Write evidence manifest
        run: |
          cat > "$RUN_DIR/manifest.json" <<JSON
          {
            "contract": "docs/phase1_evidence_contract.md",
            "commit": "${{ github.sha }}",
            "lanes": {
              "core": "cabal run acceptance-core",
              "mbtt_fast": "cabal run acceptance-mbtt -- --mbtt-fast --mbtt-max-candidates 50",
              "mbtt_full": "cabal run acceptance-mbtt (main branch only)",
              "abinitio_mbtt": "cabal run ab-initio -- --structural --mbtt-first --mbtt-max-candidates 200 --csv abinitio_mbtt_structural.csv"
            }
          }
          JSON

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pen-engine-phase1-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ${{ env.RUN_DIR }}
          retention-days: ${{ github.ref == 'refs/heads/main' && 30 || 14 }}
