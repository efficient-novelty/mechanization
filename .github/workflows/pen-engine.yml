name: PEN Engine CI

on:
  push:
    branches: [main]
    paths:
      - 'engine/**'
      - '.github/workflows/pen-engine.yml'
      - 'docs/phase1_evidence_contract.md'
  pull_request:
    branches: [main]
    paths:
      - 'engine/**'
      - '.github/workflows/pen-engine.yml'
      - 'docs/phase1_evidence_contract.md'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check Phase-1 repository hygiene
        run: |
          engine/scripts/check_phase1_repo_hygiene.sh

      - name: Check Phase-1 workflow consistency
        run: |
          engine/scripts/check_phase1_workflow_consistency.sh

      - name: Check for unresolved merge markers in Phase-1 files
        run: |
          engine/scripts/check_no_conflict_markers.sh

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6'
          cabal-version: '3.10'

      - name: Cache cabal packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/store
            engine/dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('engine/pen-engine.cabal') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Build all targets
        working-directory: engine
        run: cabal build all

      - name: Self-check evidence tooling scripts
        run: |
          engine/scripts/test_phase1_evidence_tools.sh

      - name: Check Phase-5 decoder fixtures
        run: |
          engine/scripts/check_phase5_decode_fixtures.sh

      - name: Check Phase-5 decode non-interference
        run: |
          engine/scripts/check_phase5_decode_non_interference.sh

      - name: Check Phase-6 bridge schema payloads
        run: |
          engine/scripts/check_phase6_bridge_schema.sh

      - name: Prepare Phase 1 artifact directory
        run: |
          RUN_DIR="runs/phase1_ci/${{ github.run_id }}-${{ github.run_attempt }}"
          mkdir -p "$RUN_DIR"
          echo "RUN_DIR=$RUN_DIR" >> $GITHUB_ENV

      - name: Capture environment metadata
        run: |
          {
            echo "commit_sha=${{ github.sha }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
            echo "ref=${{ github.ref }}"
            echo "runner_os=${{ runner.os }}"
            echo "runner_arch=${{ runner.arch }}"
            echo "ghc_version=$(ghc --version)"
            echo "cabal_version=$(cabal --version | head -n 1)"
          } > "$RUN_DIR/env.txt"

      - name: Lane A — acceptance-core (required)
        working-directory: engine
        run: |
          cabal run acceptance-core | tee "../$RUN_DIR/acceptance-core.log"

      - name: Lane B — acceptance-mbtt bounded (required on PR/main)
        working-directory: engine
        run: |
          cabal run acceptance-mbtt -- --mbtt-fast --mbtt-max-candidates 50             | tee "../$RUN_DIR/acceptance-mbtt-fast.log"

      - name: Lane C — acceptance-mbtt full (main branch)
        if: github.ref == 'refs/heads/main'
        working-directory: engine
        run: |
          cabal run acceptance-mbtt | tee "../$RUN_DIR/acceptance-mbtt-full.log"

      - name: Lane D1 — MBTT-first shadow replay (required)
        working-directory: engine
        run: |
          cabal run ab-initio -- --structural --phase1-shadow --mbtt-max-candidates 200 --csv abinitio_mbtt_shadow6.csv             | tee "../$RUN_DIR/abinitio_mbtt_shadow6.log"
          mv abinitio_mbtt_shadow6.csv "../$RUN_DIR/abinitio_mbtt_shadow6.csv"

      - name: Lane D2 — MBTT-first full replay (main branch)
        if: github.ref == 'refs/heads/main'
        working-directory: engine
        run: |
          cabal run ab-initio -- --structural --mbtt-first --mbtt-max-candidates 200 --csv abinitio_mbtt_structural.csv             | tee "../$RUN_DIR/abinitio_mbtt_structural.log"
          mv abinitio_mbtt_structural.csv "../$RUN_DIR/abinitio_mbtt_structural.csv"

      - name: Lane E — MBTT shadow ladder telemetry (required on PR/main)
        run: |
          mkdir -p "$RUN_DIR/ladder"
          TIMEOUT_S=45 MAX_CANDS=20 STEPS='1 2 3' \
            engine/scripts/run_phase1_shadow_ladder.sh "$RUN_DIR/ladder" \
            | tee "$RUN_DIR/phase1-shadow-ladder.log"

      - name: Lane E2 — MBTT shadow ladder gate through step 6 (main branch)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p "$RUN_DIR/ladder-main"
          TIMEOUT_S=90 MAX_CANDS=20 STEPS='1 2 3 4 5 6' REQUIRE_SUCCESS_THROUGH=6 \
            engine/scripts/run_phase1_shadow_ladder.sh "$RUN_DIR/ladder-main" \
            | tee "$RUN_DIR/phase1-shadow-ladder-main.log"

      - name: Lane P2-V4 — canonical differential gate (required on PR/main)
        run: |
          mkdir -p "$RUN_DIR/phase2/differential"
          THRESHOLD_PCT=40 MAX_CANDIDATES=120 LIB_STEP=3 MAX_BIT_BUDGET=16 MAX_ENTRIES=2 MAX_AST_DEPTH=2 \
            engine/scripts/run_phase2_canonical_differential.sh "$RUN_DIR/phase2/differential" \
            | tee "$RUN_DIR/phase2-differential.log"

      - name: Lane P2-V5 — canonical quality parity gate (required on PR/main)
        run: |
          mkdir -p "$RUN_DIR/phase2/parity"
          MAX_STEPS=2 MAX_CANDS=20 \
            engine/scripts/run_phase2_quality_parity.sh "$RUN_DIR/phase2/parity" \
            | tee "$RUN_DIR/phase2-quality-parity.log"

      - name: Lane P3-V5 — native-nu bounded evidence lane (required on PR/main)
        run: |
          mkdir -p "$RUN_DIR/phase3/native_nu"
          STEPS='1 2 3 4 5 6' \
            engine/scripts/run_phase3_native_nu_evidence.sh "$RUN_DIR/phase3/native_nu" \
            | tee "$RUN_DIR/phase3-native-nu.log"

      - name: Write evidence manifest
        run: |
          cat > "$RUN_DIR/manifest.json" <<JSON
          {
            "contract": "docs/phase1_evidence_contract.md",
            "commit": "${{ github.sha }}",
            "lanes": {
              "core": "cabal run acceptance-core",
              "mbtt_fast": "cabal run acceptance-mbtt -- --mbtt-fast --mbtt-max-candidates 50",
              "mbtt_full": "cabal run acceptance-mbtt (main branch only)",
              "abinitio_mbtt_shadow": "cabal run ab-initio -- --structural --phase1-shadow --mbtt-max-candidates 200 --csv abinitio_mbtt_shadow6.csv",
              "abinitio_mbtt_full": "cabal run ab-initio -- --structural --mbtt-first --mbtt-max-candidates 200 --csv abinitio_mbtt_structural.csv (main branch only)",
              "mbtt_shadow_ladder": "TIMEOUT_S=45 MAX_CANDS=20 STEPS='1 2 3' engine/scripts/run_phase1_shadow_ladder.sh runs/phase1_ci/<run-id>/ladder",
              "mbtt_shadow_ladder_main_gate": "TIMEOUT_S=90 MAX_CANDS=20 STEPS='1 2 3 4 5 6' REQUIRE_SUCCESS_THROUGH=6 engine/scripts/run_phase1_shadow_ladder.sh runs/phase1_ci/<run-id>/ladder-main (main branch only)",
              "phase2_canonical_differential_gate": "THRESHOLD_PCT=40 MAX_CANDIDATES=120 LIB_STEP=3 MAX_BIT_BUDGET=16 MAX_ENTRIES=2 MAX_AST_DEPTH=2 engine/scripts/run_phase2_canonical_differential.sh runs/phase1_ci/<run-id>/phase2/differential",
              "phase2_quality_parity_gate": "MAX_STEPS=2 MAX_CANDS=20 engine/scripts/run_phase2_quality_parity.sh runs/phase1_ci/<run-id>/phase2/parity",
              "phase3_native_nu_evidence": "STEPS='1 2 3 4 5 6' engine/scripts/run_phase3_native_nu_evidence.sh runs/phase1_ci/<run-id>/phase3/native_nu"
            }
          }
          JSON

      - name: Check evidence manifest schema (PR/main)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            MODE=main
          else
            MODE=pr
          fi
          engine/scripts/check_phase1_manifest_schema.sh "$RUN_DIR" "$MODE"

      - name: Build evidence summary (PR/main)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            MODE=main
          else
            MODE=pr
          fi
          engine/scripts/summarize_phase1_evidence.sh "$RUN_DIR" "$MODE"

      - name: Verify evidence artifact contract (PR/main)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            MODE=main
          else
            MODE=pr
          fi
          engine/scripts/verify_phase1_evidence.sh "$RUN_DIR" "$MODE"

      - name: Publish evidence summary in job output
        if: always()
        run: |
          if [[ -f "$RUN_DIR/summary.md" ]]; then
            cat "$RUN_DIR/summary.md" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No summary.md generated" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Publish Phase-2/P3 gate reports in job output
        if: always()
        run: |
          if [[ -f "$RUN_DIR/phase2/differential/report.md" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat "$RUN_DIR/phase2/differential/report.md" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Missing Phase-2 differential report" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [[ -f "$RUN_DIR/phase2/parity/report.md" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat "$RUN_DIR/phase2/parity/report.md" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Missing Phase-2 parity report" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [[ -f "$RUN_DIR/phase3/native_nu/report.md" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat "$RUN_DIR/phase3/native_nu/report.md" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Missing Phase-3 native-nu report" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pen-engine-phase1-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ${{ env.RUN_DIR }}
          retention-days: ${{ github.ref == 'refs/heads/main' && 30 || 14 }}
